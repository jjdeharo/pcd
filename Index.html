<!DOCTYPE html>
<!-- Plantilla correctora digital — © 2025 Juan José de Haro
     Código con licencia AGPL v3: ver LICENSE.txt
     Repositorio: https://github.com/jjdeharo/examen-digital-gas -->
<html>
  <head>
    <meta charset="UTF-8">
    <title>Lliurament d'examen</title>
    <style>
      body { font-family: Arial, sans-serif; max-width: 640px; margin: 0 auto; padding: 2rem; background: #f5f8fc; }
      h1 { font-size: 1.6rem; margin-bottom: 0.5rem; }
      form { background: #fff; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
      .question-block { margin: 1rem 0; }
      .question-title { display: block; margin-bottom: 0.35rem; font-weight: bold; }
      .options-row { display: flex; gap: 0.75rem; flex-wrap: wrap; }
      .options-row label { display: flex; align-items: center; gap: 0.35rem; padding: 0.35rem 0.6rem; border: 1px solid #ccd3de; border-radius: 20px; cursor: pointer; background: #f4f6fb; transition: background 0.2s ease, border-color 0.2s ease; }
      .options-row input[type="radio"] { margin: 0; }
      .options-row label.selected { border-color: #1976d2; background: #e3f2fd; font-weight: 600; }
      input[type="text"] { width: 100%; padding: 0.6rem; border: 1px solid #ccd3de; border-radius: 4px; font-size: 1rem; }
      button { margin-top: 1.5rem; padding: 0.8rem 1.2rem; font-size: 1rem; border: none; border-radius: 4px; color: #fff; background: #1976d2; cursor: pointer; }
      button[disabled] { background: #9fbad7; cursor: not-allowed; }
      .notice { margin: 1rem 0; padding: 0.75rem 1rem; border-radius: 6px; background: #e3f2fd; color: #0d47a1; }
      .notice.error { background: #fdecea; color: #b71c1c; }
      .notice.success { background: #e8f5e9; color: #2e7d32; }
      .hidden { display: none; }
      .lang-switch { display: flex; justify-content: flex-end; gap: 6px; align-items: center; margin: 0.5rem 0 1rem; }
      .lang-btn { background: #eceff4; color: #1a2733; border: 1px solid #c5ccda; padding: 0.25rem 0.6rem; border-radius: 999px; font-size: 0.85rem; cursor: pointer; }
      .lang-btn.active { background: #1976d2; color: #fff; border-color: #1976d2; }
      .app-footer { text-align: center; color: #607d8b; font-size: 0.9rem; margin: 2rem 0 1.5rem; }
      .app-footer a { color: #376082; text-decoration: none; }
      .app-footer a:hover { text-decoration: underline; }
      .app-footer .lic-line { margin-top: 0.35rem; }
      .app-footer img.cc { vertical-align: middle; height: 20px; margin-left: 6px; opacity: 0.9; }
    </style>
  </head>
  <body>
    <h1 data-i18n="title">Lliurament d'examen</h1>
    <div class="lang-switch" id="student-lang-switch" title="Idioma/Language">
      <button type="button" class="lang-btn" data-lang="auto">AUTO</button>
      <button type="button" class="lang-btn" data-lang="ca">CA</button>
      <button type="button" class="lang-btn" data-lang="es">ES</button>
    </div>
    <div id="status-box" class="notice hidden"></div>
    <form id="exam-form" class="hidden">
      <label for="student-code" data-i18n="student_label">Nom/codi de l'alumne</label>
      <input type="text" id="student-code" name="studentCode" autocomplete="off" required />
      <div id="questions-container"></div>
      <button id="submit-btn" type="submit" data-i18n="submit">Envia les respostes</button>
    </form>
    <div id="message" class="notice hidden"></div>
    
    <section id="thanks-screen" class="hidden">
      <h2 data-i18n="thanks_title">Moltes gràcies!</h2>
      <p data-i18n="thanks_desc">Hem rebut les teves respostes. Pots tancar aquesta finestra.</p>
    </section>

    <script>
      const EXAM_ID = <?!= JSON.stringify(examId) ?>;
      const LANG_STORAGE_KEY = 'examApp:lang';
      const I18N = {
        ca: {
          title: "Lliurament d'examen",
          student_label: "Nom/codi de l'alumne",
          submit: 'Envia les respostes',
          thanks_title: 'Moltes gràcies!',
          thanks_desc: 'Hem rebut les teves respostes. Pots tancar aquesta finestra.',
          missing_exam: "Falta l'identificador de l'examen a la URL.",
          student_needed: "Introdueix el codi de l'alumne.",
          sending: 'Enviant les respostes...',
          generic_error: "S'ha produït un error inesperat.",
          question_prefix: 'Pregunta',
          blank: 'En blanc'
        },
        es: {
          title: 'Entrega del examen',
          student_label: 'Nombre/código del alumno',
          submit: 'Enviar respuestas',
          thanks_title: '¡Muchas gracias!',
          thanks_desc: 'Hemos recibido tus respuestas. Puedes cerrar esta ventana.',
          missing_exam: 'Falta el identificador del examen en la URL.',
          student_needed: 'Introduce el código del alumno.',
          sending: 'Enviando respuestas...',
          generic_error: 'Se ha producido un error inesperado.',
          question_prefix: 'Pregunta',
          blank: 'En blanco'
        }
      };
      const I18N_FOOTER = {
        ca: {
          line1: '<a href="https://bilateria.es" target="_blank" rel="noopener">© Juan José de Haro</a>',
          line2: 'Llicència del codi: <a href="https://github.com/jjdeharo/examen-digital-gas/blob/main/LICENSE.txt" target="_blank" rel="noopener">AGPL v3</a> · Contingut: <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener">CC BY-SA 4.0</a> <img class="cc" alt="CC BY-SA 4.0" src="https://licensebuttons.net/l/by-sa/4.0/88x31.png" />'
        },
        es: {
          line1: '<a href="https://bilateria.es" target="_blank" rel="noopener">© Juan José de Haro</a>',
          line2: 'Licencia del código: <a href="https://github.com/jjdeharo/examen-digital-gas/blob/main/LICENSE.txt" target="_blank" rel="noopener">AGPL v3</a> · Contenido: <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener">CC BY-SA 4.0</a> <img class="cc" alt="CC BY-SA 4.0" src="https://licensebuttons.net/l/by-sa/4.0/88x31.png" />'
        }
      };
      function detectLang() {
        const saved = (safeStorage().getItem(LANG_STORAGE_KEY) || '').toLowerCase();
        if (saved === 'ca' || saved === 'es') return saved;
        const nav = (navigator.language || navigator.userLanguage || 'ca').toLowerCase();
        return nav.startsWith('es') ? 'es' : 'ca';
      }
      let currentLang = detectLang();
      function t(key) {
        const table = I18N[currentLang] || I18N.ca;
        return table[key] || key;
      }
      function applyStaticI18n() {
        document.querySelectorAll('[data-i18n]').forEach(el => {
          const key = el.getAttribute('data-i18n');
          if (key) el.textContent = t(key);
        });
      }
      function setLang(lang) {
        currentLang = (lang === 'es' || lang === 'ca') ? lang : detectLang();
        try { safeStorage().setItem(LANG_STORAGE_KEY, lang); } catch (e) {}
        applyStaticI18n();
        // Re-render dynamic bits if form is visible
        if (examConfig) {
          renderForm(examConfig);
        }
        renderFooter();
      }
      let examConfig = null;
      let examActive = false;
      let examSubmitted = false;
      let wakeLock = null;
      let preventLeaveBound = false;
      let fsHandlersBound = false;
      let fsRequested = false;

      document.addEventListener('DOMContentLoaded', () => {
        // Instal·la proteccions de sortida com més aviat millor
        // No avisos de focus ni confirmacions; només pantalla completa si cal
        installFullscreenHandlers();
        applyStaticI18n();
        renderFooter();
        // Botonera de idioma
        try {
          const root = document.getElementById('student-lang-switch');
          if (root) {
            const saved = (safeStorage().getItem(LANG_STORAGE_KEY) || 'auto');
            const activate = (v) => { root.querySelectorAll('.lang-btn').forEach(b => b.classList.toggle('active', b.dataset.lang === v)); };
            activate((saved === 'ca' || saved === 'es') ? saved : 'auto');
            root.addEventListener('click', (ev) => {
              const btn = ev.target.closest('.lang-btn'); if (!btn) return;
              const v = btn.dataset.lang; try { safeStorage().setItem(LANG_STORAGE_KEY, v); } catch (e) {}
              setLang((v === 'ca' || v === 'es') ? v : detectLang());
              activate(v);
            });
          }
        } catch (e) {}
        if (!EXAM_ID) {
          showMessage(t('missing_exam'), true);
          return;
        }
        google.script.run
          .withSuccessHandler(renderForm)
          .withFailureHandler(showError)
          .getConfig(EXAM_ID, currentLang);
        const formEl = document.getElementById('exam-form');
        formEl.addEventListener('submit', handleSubmit);
        // Desat regular per si algun canvi no dispara events
        setInterval(saveDraft, 2000);
     });

      function renderForm(config) {
        examConfig = config;
        const form = document.getElementById('exam-form');
        const container = document.getElementById('questions-container');
        const statusBox = document.getElementById('status-box');
        container.innerHTML = '';

        statusBox.className = 'notice hidden';
        statusBox.textContent = '';
        if (config.statusMessage) {
          statusBox.textContent = config.statusMessage;
          statusBox.classList.remove('hidden');
          if (config.acceptingSubmissions) {
            statusBox.classList.add('success');
          } else {
            statusBox.classList.add('error');
          }
        }

        const submitButton = document.getElementById('submit-btn');

        if (!config.acceptingSubmissions) {
          submitButton.disabled = true;
          form.classList.add('hidden');
          const messageBox = document.getElementById('message');
          messageBox.textContent = '';
          messageBox.classList.add('hidden');
          return;
        }

        submitButton.disabled = false;
        const questionOrder = Array.from({ length: config.nQuestions }, (_, index) => index);
        if (config.shuffleQuestions) {
          shuffleArray(questionOrder);
        }

        questionOrder.forEach(questionIndex => {
          const block = document.createElement('div');
          block.className = 'question-block';

          const title = document.createElement('span');
          title.className = 'question-title';
          title.textContent = t('question_prefix') + ' ' + (questionIndex + 1);
          block.appendChild(title);

          const optionsRow = document.createElement('div');
          optionsRow.className = 'options-row';

          const radios = [];

          const blankId = `q-${questionIndex}-blank`;
          const blankLabel = document.createElement('label');
          blankLabel.setAttribute('for', blankId);
          const blankRadio = document.createElement('input');
          blankRadio.type = 'radio';
          blankRadio.name = `q-${questionIndex}`;
          blankRadio.id = blankId;
          blankRadio.value = '';
          blankRadio.checked = true;
          blankLabel.appendChild(blankRadio);
          const blankText = document.createElement('span');
          blankText.textContent = t('blank');
          blankLabel.appendChild(blankText);
          blankLabel.classList.add('selected');
          optionsRow.appendChild(blankLabel);
          radios.push(blankRadio);

          const optionsList = config.options.slice();
          if (config.shuffleAnswers) {
            shuffleArray(optionsList);
          }

          optionsList.forEach(option => {
            const optionId = `q-${questionIndex}-${option}`;
            const optionLabel = document.createElement('label');
            optionLabel.setAttribute('for', optionId);

            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = `q-${questionIndex}`;
            radio.id = optionId;
            radio.value = option;

            optionLabel.appendChild(radio);
            const text = document.createElement('span');
            text.textContent = option;
            optionLabel.appendChild(text);
            optionsRow.appendChild(optionLabel);
            radios.push(radio);
          });

          radios.forEach(radio => {
            radio.addEventListener('change', () => {
              Array.from(optionsRow.querySelectorAll('label')).forEach(lbl => lbl.classList.remove('selected'));
              const selectedLabel = radio.parentElement;
              if (selectedLabel) {
                selectedLabel.classList.add('selected');
              }
              saveDraft();
            });
          });

          block.appendChild(optionsRow);
          container.appendChild(block);
        });

        form.classList.remove('hidden');

        // Connecta auto-desat i pantalla completa si està activada
        tryRequestWakeLock();
        attachDraftHandlers();
        restoreDraft();
        examActive = true;

        // Intenta entrar a pantalla completa al començar el examen (si el profe ho ha activat)
        if (config && config.enforceFullscreen) {
          prepareEnterFullscreen();
        }
      }
      function renderFooter() {
        try {
          const f = I18N_FOOTER[currentLang] || I18N_FOOTER.ca;
          const l1 = document.getElementById('footer-line1');
          const l2 = document.getElementById('footer-line2');
          if (l1) l1.innerHTML = f.line1;
          if (l2) l2.innerHTML = f.line2;
        } catch (e) {}
      }

      function handleSubmit(event) {
        event.preventDefault();
        if (!examConfig) return;

        const button = document.getElementById('submit-btn');
        const studentField = document.getElementById('student-code');
        const studentCode = studentField.value.trim();
        if (!studentCode) {
          showMessage('Introdueix el codi de l\'alumne.', true);
          studentField.focus();
          return;
        }

        const answers = [];
        for (let i = 0; i < examConfig.nQuestions; i++) {
          const blank = document.querySelector(`#q-${i}-blank`);
          if (blank && blank.checked) {
            answers.push('');
            continue;
          }
          const selected = document.querySelector(`input[name="q-${i}"]:checked`);
          answers.push(selected ? selected.value.toUpperCase() : '');
        }

        const payload = {
          examId: EXAM_ID,
          studentCode,
          answers,
          userAgent: navigator.userAgent || 'unknown'
        };

        button.disabled = true;
        showMessage(t('sending'), false);

        google.script.run
          .withSuccessHandler(() => {
            examSubmitted = true;
            examActive = false;
            clearDraft();
            // Surt de pantalla completa després d'enviar
            try { exitFullscreen(); } catch (e) {}
            document.getElementById('exam-form').classList.add('hidden');
            document.getElementById('message').classList.add('hidden');
            document.getElementById('thanks-screen').classList.remove('hidden');
          })
          .withFailureHandler(err => {
            showError(err);
            button.disabled = false;
          })
          .submitResponse(payload);
      }

      function shuffleArray(items) {
        for (let i = items.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          const temp = items[i];
          items[i] = items[j];
          items[j] = temp;
        }
      }

      function showMessage(text, isError = false) {
        const box = document.getElementById('message');
        box.textContent = text;
        box.classList.remove('hidden', 'error', 'success');
        box.classList.add(isError ? 'error' : 'success');
      }

      function showError(error) {
        const description = (error && error.message) ? error.message : t('generic_error');
        showMessage(description, true);
      }

      // Impedeix que es tanqui la pestanya o es canviï de pàgina sense confirmar
      function installPreventLeave() { /* eliminat segons requisit */ }

      // Manté la pantalla activa en dispositius compatibles (opcional)
      async function tryRequestWakeLock() {
        try {
          if ('wakeLock' in navigator && navigator.wakeLock && !wakeLock) {
            wakeLock = await navigator.wakeLock.request('screen');
            wakeLock.addEventListener && wakeLock.addEventListener('release', () => { /* noop */ });
          }
        } catch (err) {
          // Ignora si el navegador no ho permet
        }
      }

      // Esborrany local per evitar pèrdua de respostes
      function draftKey() { return 'examDraft:' + EXAM_ID; }
      function safeStorage() {
        try { localStorage.setItem('__t','1'); localStorage.removeItem('__t'); return localStorage; } catch (e) {}
        try { sessionStorage.setItem('__t','1'); sessionStorage.removeItem('__t'); return sessionStorage; } catch (e) {}
        let mem = {};
        return {
          getItem: k => mem[k] || null,
          setItem: (k,v) => { mem[k] = String(v); },
          removeItem: k => { delete mem[k]; }
        };
      }
      const storage = safeStorage();
      function attachDraftHandlers() {
        const studentField = document.getElementById('student-code');
        if (studentField) {
          studentField.addEventListener('input', saveDraft);
        }
      }
      function collectAnswersArray() {
        if (!examConfig) return [];
        const out = [];
        for (let i = 0; i < examConfig.nQuestions; i++) {
          const blank = document.querySelector(`#q-${i}-blank`);
          if (blank && blank.checked) { out.push(''); continue; }
          const selected = document.querySelector(`input[name="q-${i}"]:checked`);
          out.push(selected ? String(selected.value || '').toUpperCase() : '');
        }
        return out;
      }
      function saveDraft() {
        if (!examActive || examSubmitted) return;
        try {
          const payload = {
            studentCode: (document.getElementById('student-code').value || '').trim(),
            answers: collectAnswersArray(),
            ts: Date.now()
          };
          storage.setItem(draftKey(), JSON.stringify(payload));
        } catch (err) {}
      }
      function restoreDraft() {
        try {
          const raw = storage.getItem(draftKey());
          if (!raw) return;
          const data = JSON.parse(raw);
          if (data && typeof data === 'object') {
            if (data.studentCode) {
              const studentField = document.getElementById('student-code');
              if (studentField) studentField.value = data.studentCode;
            }
            if (Array.isArray(data.answers) && examConfig) {
              data.answers.forEach((val, i) => {
                const v = String(val || '').toUpperCase();
                if (!v) {
                  const blank = document.querySelector(`#q-${i}-blank`);
                  if (blank) blank.checked = true;
                } else {
                  const radio = document.querySelector(`#q-${i}-${v}`);
                  if (radio) radio.checked = true;
                }
              });
            }
          }
        } catch (err) {}
      }
      function clearDraft() {
        try { storage.removeItem(draftKey()); } catch (err) {}
      }

      // ===== Pantalla completa =====
      function isFullscreen() {
        return Boolean(document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement);
      }
      async function requestFullscreen() {
        const el = document.documentElement;
        try {
          if (el.requestFullscreen) { await el.requestFullscreen(); }
          else if (el.webkitRequestFullscreen) { el.webkitRequestFullscreen(); }
          else if (el.msRequestFullscreen) { el.msRequestFullscreen(); }
        } catch (err) {
          // ignorar; s'intentarà després amb gest
        }
      }
      async function exitFullscreen() {
        try {
          if (document.exitFullscreen) { await document.exitFullscreen(); }
          else if (document.webkitExitFullscreen) { document.webkitExitFullscreen(); }
          else if (document.msExitFullscreen) { document.msExitFullscreen(); }
        } catch (err) {}
      }
      function enterFullscreenIfNeeded() {
        if (!examActive || examSubmitted) return;
        if (!isFullscreen()) {
          requestFullscreen();
        }
      }
      function prepareEnterFullscreen() {
        // Intenta immediatament
        if (!fsRequested) {
          fsRequested = true;
          requestFullscreen();
        }
        // I assegura-ho al primer gest de l'usuari
        const opts = { capture: true };
        window.addEventListener('click', enterFullscreenIfNeeded, opts);
        window.addEventListener('keydown', enterFullscreenIfNeeded, opts);
      }
      function installFullscreenHandlers() {
        if (fsHandlersBound) return;
        const handler = () => {
          // Sense avisos; si surt, reintentem al següent clic/tecla
        };
        document.addEventListener('fullscreenchange', handler);
        document.addEventListener('webkitfullscreenchange', handler);
        document.addEventListener('msfullscreenchange', handler);
        document.addEventListener('fullscreenerror', handler);
        fsHandlersBound = true;
      }
    </script>
    <footer class="app-footer">
      <div id="footer-line1">&nbsp;</div>
      <div id="footer-line2" class="lic-line">&nbsp;</div>
    </footer>
  </body>
</html>
